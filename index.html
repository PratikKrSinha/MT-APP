<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard | MT App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://apis.mappls.com/advancedmaps/api/v1/css/mappls-maps.css">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none !important; }
        #map { height: 100%; width: 100%; }
        html, body { height: 100%; margin: 0; padding: 0; }
        .mappls-search-widget-result-container { z-index: 1000 !important; }
        #map-container { position: relative; }
        #controls { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 1000; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Login Section -->
    <div id="login-container" class="flex items-center justify-center h-full">
        <!-- ... unchanged login UI ... -->
    </div>

    <!-- Map Section -->
    <div id="map-container" class="h-full w-full hidden">
        <div id="map"></div>
        <div id="controls" class="bg-white rounded-lg shadow-lg p-4 flex flex-col md:flex-row items-center gap-4 w-11/12 max-w-2xl">
            <!-- ... unchanged controls ... -->
        </div>
    </div>

    <script src="https://apis.mappls.com/advancedmaps/api/v1/bf079bfe7e192eb2c2b58117e2801f058/map_sdk"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            onSnapshot, 
            setDoc 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase configuration (REMOVE BEFORE DEPLOYING TO PUBLIC REPO)
        const firebaseConfig = { /* ... */ };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // DOM Elements
        const loginContainer = document.getElementById('login-container');
        const mapContainer = document.getElementById('map-container');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const userNameEl = document.getElementById('user-name');
        const userEmailEl = document.getElementById('user-email');
        const userPhotoEl = document.getElementById('user-photo');

        // Map variables
        let map, marker, polyline, routeCoordinates = [];
        let unsubscribeFromFirestore = null;
        let currentUID = null;
        const ROUTE_THRESHOLD = 100; // meters

        // Event listeners
        loginButton.onclick = () => {
            loginButton.disabled = true;
            signInWithPopup(auth, provider).catch(handleAuthError);
        };
        
        logoutButton.onclick = () => signOut(auth).catch(handleAuthError);

        // Auth state handler
        onAuthStateChanged(auth, (user) => {
            if (user) handleLogin(user);
            else handleLogout();
        });

        function handleLogin(user) {
            currentUID = user.uid;
            loginContainer.classList.add('hidden');
            mapContainer.classList.remove('hidden');
            
            userNameEl.textContent = user.displayName || 'Driver';
            userEmailEl.textContent = user.email || '';
            userPhotoEl.src = user.photoURL || 'https://via.placeholder.com/40';
            
            initMap();
        }

        function handleLogout() {
            if (unsubscribeFromFirestore) unsubscribeFromFirestore();
            
            currentUID = null;
            loginContainer.classList.remove('hidden');
            mapContainer.classList.add('hidden');
            
            // Clean up map resources
            if (map) map.remove();
            map = null;
            marker = null;
            polyline = null;
        }

        function initMap() {
            const mappls = window.mappls;

            map = new mappls.Map('map', {
                center: [28.4744, 77.5040],
                zoom: 12,
                tilt: 0,
                traffic: false
            });

            map.on('load', () => {
                // Create initial marker
                marker = new mappls.Marker({
                    map: map,
                    position: map.getCenter(),
                    icon: 'https://apis.mappls.com/map_sdk/images/marker.png',
                    fit: false
                });

                // Initialize search widget
                new mappls.search(document.getElementById("search-widget"), {}, (data) => {
                    if (data?.[0]) {
                        const place = data[0];
                        setDoc(doc(db, "locations", currentUID), { 
                            destination: { 
                                latitude: place.latitude, 
                                longitude: place.longitude 
                            },
                            destinationName: place.placeName 
                        }, { merge: true });
                    }
                });

                // Start listening to Firestore updates
                listenToLocationUpdates();
            });
        }

        function listenToLocationUpdates() {
            if (unsubscribeFromFirestore) unsubscribeFromFirestore();
            
            unsubscribeFromFirestore = onSnapshot(
                doc(db, "locations", currentUID), 
                (docSnap) => {
                    if (!docSnap.exists()) return;
                    
                    const data = docSnap.data();
                    const liveLocation = data.location;
                    const destination = data.destination;

                    // Update current location
                    if (liveLocation) {
                        const newPos = [liveLocation.latitude, liveLocation.longitude];
                        marker.setPosition(newPos);
                        
                        // Only center if no destination
                        if (!destination) map.setCenter(newPos);
                    }

                    // Handle routing
                    if (liveLocation && destination) {
                        handleRouteUpdate(
                            liveLocation, 
                            destination,
                            data.destinationName
                        );
                    } else if (polyline) {
                        polyline.setMap(null);
                        polyline = null;
                    }
                },
                (error) => {
                    console.error("Firestore error:", error);
                    alert("Error retrieving location data");
                }
            );
        }

        function handleRouteUpdate(origin, destination, destName) {
            const needsUpdate = shouldUpdateRoute(origin, destination);
            
            if (needsUpdate) {
                calculateRoute(
                    origin, 
                    destination,
                    (geometry) => {
                        drawRoute(geometry);
                        showRouteInfo(destName);
                    }
                );
            }
        }

        function shouldUpdateRoute(origin, destination) {
            if (!polyline) return true;
            
            // Calculate distance from last route point
            const lastPoint = routeCoordinates[routeCoordinates.length - 1];
            const distance = getDistance(
                lastPoint.lat, 
                lastPoint.lng, 
                destination.latitude, 
                destination.longitude
            );
            
            return distance > ROUTE_THRESHOLD;
        }

        function calculateRoute(origin, dest, callback) {
            const originStr = `${origin.longitude},${origin.latitude}`;
            const destStr = `${dest.longitude},${dest.latitude}`;
            
            fetch(`https://apis.mappls.com/advancedmaps/v1/bf079bfe7e192eb2c2b58117e2801f058/route_adv/driving/${originStr};${destStr}?geometries=polyline&overview=full`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    if (data.routes?.[0]?.geometry) {
                        callback(data.routes[0].geometry);
                    }
                })
                .catch(error => {
                    console.error('Routing error:', error);
                    alert('Failed to calculate route');
                });
        }

        function drawRoute(geometry) {
            const mappls = window.mappls;
            
            // Clear previous route
            if (polyline) polyline.setMap(null);
            
            // Decode polyline for later calculations
            routeCoordinates = mappls.Polyline.decode(geometry);
            
            // Draw new route
            polyline = new mappls.Polyline({
                map: map,
                path: routeCoordinates,
                strokeColor: '#0D6BFF',
                strokeWeight: 5,
                strokeOpacity: 0.7
            });
            
            // Fit map to route
            const bounds = new mappls.Bounds();
            routeCoordinates.forEach(coord => bounds.extend(coord));
            map.fitBounds(bounds, { padding: 50, duration: 1000 });
        }

        function showRouteInfo(destName) {
            // Implement your route info display UI here
            console.log(`Navigating to: ${destName || 'Destination'}`);
        }

        // Helper function to calculate distance between coordinates
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        function handleAuthError(error) {
            console.error("Authentication error:", error);
            alert(`Login failed: ${error.message}`);
            loginButton.disabled = false;
        }
    </script>
</body>
</html>